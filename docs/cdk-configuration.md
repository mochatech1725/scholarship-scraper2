# CDK Configuration Documentation

## Overview

The project uses environment-specific CDK configuration files to manage different deployment stages (development, staging, production). Each environment has its own configuration file with specific settings and context values. The infrastructure now includes S3 buckets for raw data storage alongside DynamoDB for processed data.

## Configuration Files

### CDK Configuration Files (`cdk/config/`)

#### `cdk.dev.json` - Development Environment
- **Environment**: `dev`
- **Purpose**: Local development and testing
- **Resources**: Minimal resources for cost optimization
- **S3 Bucket**: Raw data storage with lifecycle policies
- **Removal Policy**: Resources are destroyed when stack is deleted

#### `cdk.staging.json` - Staging Environment
- **Environment**: `staging`
- **Purpose**: Pre-production testing and validation
- **Resources**: Moderate resources for testing
- **S3 Bucket**: Raw data storage with lifecycle policies
- **Removal Policy**: Resources are destroyed when stack is deleted

#### `cdk.prod.json` - Production Environment
- **Environment**: `prod`
- **Purpose**: Live production environment
- **Resources**: High availability and performance
- **S3 Bucket**: Raw data storage with enhanced lifecycle policies
- **Removal Policy**: Resources are retained when stack is deleted

## Configuration Structure

Each CDK configuration file contains:

```json
{
  "app": "npx ts-node --prefer-ts-exts src/cdk/bin/scholarship-scraper.ts",
  "watch": {
    "include": ["src/cdk/**"],
    "exclude": ["README.md", "src/cdk/**/*.d.ts", "src/cdk/**/*.js", ...]
  },
  "context": {
    "environment": "dev|staging|prod",
    // CDK feature flags and settings
  }
}
```

### Key Configuration Elements

1. **App Entry Point**: Points to the main CDK application
2. **Watch Configuration**: Files to monitor for changes during development
3. **Context**: Environment-specific variables and CDK feature flags

## Infrastructure Components

### S3 Bucket Configuration
- **Bucket Name**: `scholarship-raw-data-{environment}-{account}`
- **Encryption**: Server-side encryption enabled
- **Access Control**: Block all public access
- **Lifecycle Policies**:
  - Transition to IA after 30 days
  - Transition to Glacier after 90 days
- **Versioning**: Enabled for data protection

### DynamoDB Tables
- **Scholarships Table**: `scholarships-{environment}`
- **Jobs Table**: `scholarship-scraper-jobs-{environment}`
- **Indexes**: Multiple GSIs for efficient querying

### IAM Roles and Policies
- **Lambda Role**: DynamoDB, S3, Batch, Bedrock access
- **Batch Job Role**: DynamoDB, S3, ECR, Bedrock access
- **Batch Service Role**: Batch service permissions

## Deployment Commands

### Development
```bash
npm run deploy:dev
```

### Staging
```bash
npm run deploy:staging
```

### Production
```bash
npm run deploy:prod
```

## Other Commands

### View Changes
```bash
npm run diff:dev      # View changes for development
npm run diff:staging  # View changes for staging
npm run diff:prod     # View changes for production
```

### Destroy Infrastructure
```bash
npm run destroy:dev      # Destroy development environment
npm run destroy:staging  # Destroy staging environment
npm run destroy:prod     # Destroy production environment
```

## Environment-Specific Settings

### Development (`dev`)
- **DynamoDB Billing**: Pay-per-request
- **S3 Lifecycle**: Standard (30 days IA, 90 days Glacier)
- **Batch vCPUs**: 256
- **Log Retention**: 30 days
- **Scraping Schedule**: Every hour
- **Resource Removal**: Destroy on stack deletion

### Staging (`staging`)
- **DynamoDB Billing**: Pay-per-request
- **S3 Lifecycle**: Standard (30 days IA, 90 days Glacier)
- **Batch vCPUs**: 256
- **Log Retention**: 60 days
- **Scraping Schedule**: Every 2 hours
- **Resource Removal**: Destroy on stack deletion

### Production (`prod`)
- **DynamoDB Billing**: Provisioned (for predictable costs)
- **S3 Lifecycle**: Enhanced (30 days IA, 90 days Glacier, 365 days Deep Archive)
- **Batch vCPUs**: 512
- **Log Retention**: 90 days
- **Scraping Schedule**: Every hour
- **Resource Removal**: Retain on stack deletion

## Integration with Other Configuration

### Environment Variables
The CDK configuration works with environment variables defined in `.env`:
- `ENVIRONMENT`: Determines which environment is being deployed
- `AWS_REGION`: AWS region for deployment
- `AWS_ACCESS_KEY_ID` / `AWS_SECRET_ACCESS_KEY`: AWS credentials
- `RAW_DATA_BUCKET`: S3 bucket name (auto-generated by CDK)

### Application Configuration
The CDK stack reads from `cdk/config/environments.json` to get environment-specific settings:
- VPC configuration
- DynamoDB settings
- S3 bucket settings
- Batch job settings
- Logging configuration

## Storage Architecture

### S3 Raw Data Storage
- **Purpose**: Store raw HTML, JSON responses, and API data
- **Organization**: `{scraper-name}/{year}/{month}/{day}/{timestamp}-{page-id}.html`
- **Benefits**: Cost-effective storage for large raw data volumes
- **Access**: Private access only, no public read/write

### DynamoDB Processed Data
- **Purpose**: Store structured, queryable scholarship information
- **Optimized**: For fast queries and application access
- **Indexed**: Multiple GSIs for efficient filtering

## Best Practices

### 1. Environment Isolation
- Each environment has its own stack name
- Separate DynamoDB tables per environment
- Separate S3 buckets per environment
- Isolated IAM roles and policies

### 2. Cost Optimization
- Development uses minimal resources
- Staging uses moderate resources
- Production uses appropriate resources for performance
- S3 lifecycle policies reduce long-term storage costs

### 3. Security
- Production retains resources to prevent accidental deletion
- Environment-specific IAM policies
- S3 encryption and access controls
- Proper resource tagging for cost tracking

### 4. Monitoring
- Different log retention periods per environment
- Environment-specific CloudWatch configurations
- S3 storage monitoring and alerts
- Separate monitoring and alerting

### 5. Data Management
- Raw data preserved in S3 for debugging and analysis
- Processed data optimized in DynamoDB for application access
- Lifecycle policies automatically manage data costs
- Versioning enabled for data protection

## Troubleshooting

### Common Issues

1. **Configuration Not Found**
   ```bash
   # Ensure you're using the correct config file
   npm run deploy:dev -c cdk/config/cdk.dev.json
   ```

2. **Environment Mismatch**
   ```bash
   # Check environment variable
   echo $ENVIRONMENT
   # Should match the environment in the CDK config
   ```

3. **Permission Issues**
   ```bash
   # Verify AWS credentials
   aws sts get-caller-identity
   ```

4. **S3 Access Issues**
   ```bash
   # Check S3 bucket permissions
   aws s3 ls s3://scholarship-raw-data-{env}-{account}/
   ```

### Debugging

1. **View Configuration**
   ```bash
   # Check what configuration CDK is using
   npm run diff:dev
   ```

2. **Validate Configuration**
   ```bash
   # Validate CDK configuration
   cdk synth -c cdk/config/cdk.dev.json
   ```

3. **Check Context**
   ```bash
   # View context values
   cdk context -c cdk/config/cdk.dev.json
   ```

4. **S3 Bucket Verification**
   ```bash
   # Check S3 bucket creation
   aws s3api list-buckets --query 'Buckets[?contains(Name, `scholarship-raw-data`)].Name'
   ```

## Adding New Environments

To add a new environment (e.g., `test`):

1. **Create Configuration File**
   ```bash
   cp cdk/config/cdk.dev.json cdk/config/cdk.test.json
   ```

2. **Update Context**
   ```json
   {
     "context": {
       "environment": "test"
     }
   }
   ```

3. **Add Package Scripts**
   ```json
   {
     "scripts": {
       "deploy:test": "cdk deploy --profile default -c cdk/config/cdk.test.json",
       "destroy:test": "cdk destroy --profile default -c cdk/config/cdk.test.json",
       "diff:test": "cdk diff -c cdk/config/cdk.test.json"
     }
   }
   ```

4. **Update Environment Config**
   Add test environment settings to `cdk/config/environments.json`

5. **S3 Bucket Configuration**
   The S3 bucket will be automatically created with the naming convention:
   `scholarship-raw-data-test-{account}`

## Cost Considerations

### S3 Storage Costs
- **Standard Storage**: ~$0.023/GB/month
- **IA Storage**: ~$0.0125/GB/month (after 30 days)
- **Glacier Storage**: ~$0.004/GB/month (after 90 days)
- **Lifecycle Policies**: Automatically reduce costs over time

### DynamoDB Costs
- **On-Demand**: Pay per request (good for variable workloads)
- **Provisioned**: Fixed capacity (good for predictable workloads)
- **Storage**: ~$0.25/GB/month

### Optimization Strategies
- Use S3 for raw data (much cheaper than DynamoDB)
- Use DynamoDB for processed data (fast queries)
- Implement lifecycle policies for automatic cost reduction
- Monitor usage with CloudWatch metrics

This configuration structure provides a clean, maintainable way to manage multiple deployment environments with appropriate settings for each stage of the development lifecycle, including the new S3-based raw data storage architecture. 